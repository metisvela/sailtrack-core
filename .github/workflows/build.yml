name: Build image

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DIETPI_IMAGE_NAME: DietPi_RPi-ARMv6-Buster
      OUTPUT_IMAGE_NAME: SailTrack_Core-ARMv6-Buster
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          path: sailtrack-core

      - name: Download compressed image
        run: wget https://dietpi.com/downloads/images/$DIETPI_IMAGE_NAME.7z

      - name: Extract image
        run: |
          7z e -o$OUTPUT_IMAGE_NAME $DIETPI_IMAGE_NAME.7z
          mv ${OUTPUT_IMAGE_NAME}/${DIETPI_IMAGE_NAME}.img ${OUTPUT_IMAGE_NAME}/${OUTPUT_IMAGE_NAME}.img

      - name: Mount image
        run: |
          DEV=$(sudo losetup --show -f -P $OUTPUT_IMAGE_NAME/$OUTPUT_IMAGE_NAME.img)
          PART=${DEV}p1
          MOUNT=/mnt/$(basename $PART)
          echo "DEV=$DEV" >> $GITHUB_ENV
          echo "PART=$PART" >> $GITHUB_ENV
          echo "MOUNT=$MOUNT" >> $GITHUB_ENV
          sudo mkdir $MOUNT
          sudo mount $PART $MOUNT

      - name: Copy files and directories
        run: |
          cp sailtrack-core/README.md ${OUTPUT_IMAGE_NAME}/README.md
          mv sailtrack-core/LICENSE sailtrack-core/sailtrack-LICENSE.txt
          mv sailtrack-core/README.md sailtrack-core/sailtrack-README.md
          sudo rsync -rt --exclude=".*" --exclude="hardware" sailtrack-core/ $MOUNT

      - name: Unmount image
        run: |
          sudo umount $MOUNT
          sudo losetup -d $DEV

      - name: Update hashes
        run: |
          echo -e "FILE:\t\t${OUTPUT_IMAGE_NAME}.img" > ${OUTPUT_IMAGE_NAME}/hash.txt
          echo -e "DATE:\t\t$(date)" >> ${OUTPUT_IMAGE_NAME}/hash.txt
          echo -e "MD5:\t\t$(md5sum ${OUTPUT_IMAGE_NAME}/${OUTPUT_IMAGE_NAME}.img | mawk '{print $1}')" >> ${OUTPUT_IMAGE_NAME}/hash.txt
          echo -e "SHA1:\t\t$(sha1sum ${OUTPUT_IMAGE_NAME}/${OUTPUT_IMAGE_NAME}.img | mawk '{print $1}')" >> ${OUTPUT_IMAGE_NAME}/hash.txt
          echo -e "SHA256:\t$(sha256sum ${OUTPUT_IMAGE_NAME}/${OUTPUT_IMAGE_NAME}.img | mawk '{print $1}')" >> ${OUTPUT_IMAGE_NAME}/hash.txt

      - name: Upload image
        uses: actions/upload-artifact@v2
        with:
          path: ${{ env.OUTPUT_IMAGE_NAME }}
          name: ${{ env.OUTPUT_IMAGE_NAME }}
